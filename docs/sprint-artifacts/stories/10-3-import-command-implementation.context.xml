<story-context id="{bmad_folder}/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>10</epicId>
    <storyId>3</storyId>
    <title>Implement `import` Command</title>
    <status>drafted</status>
    <generatedAt>2025-11-22</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/10-3-import-command-implementation.md</sourceStoryPath>
  </metadata>
  <story>
    <asA>a user</asA>
    <iWant>to import a capsule into my vault with a preview and backup safety</iWant>
    <soThat>I can safely and confidently add new knowledge to my vault</soThat>
    <tasks>
- [ ] **Task 1: Implement `import_capsule` Command Structure** (AC: #1, #3, #4)
    - [ ] Subtask 1.1: Create `capsule/commands/import_cmd.py`.
    - [ ] Subtask 1.2: Define the `import_capsule` function with Typer arguments: `path`, `auto_approve`, and `dry_run`.
    - [ ] Subtask 1.3: Add the new command to the main CLI app in `capsule/cli.py`.
- [ ] **Task 2: Integrate Core Importer and Preview Logic** (AC: #1, #4)
    - [ ] Subtask 2.1: In the command, instantiate the `Importer` service from `capsule.core.importer`.
    - [ ] Subtask 2.2: Call the `importer.get_preview()` method to get the `ImportPreview` data.
    - [ ] Subtask 2.3: Implement a `rich`-based display function to format and print the preview attractively.
    - [ ] Subtask 2.4: Implement the `--dry-run` logic to show the preview and exit.
- [ ] **Task 3: Implement Interactive Approval and Execution** (AC: #2, #3)
    - [ ] Subtask 3.1: If not `--yes` or `--dry-run`, use the `questionary` library to prompt the user for confirmation.
    - [ ] Subtask 3.2: If the user confirms, call the `importer.execute_import()` method.
    - [ ] Subtask 3.3: Handle user cancellation gracefully, exiting with a clear message.
- [ ] **Task 4: Implement Comprehensive Testing** (AC: #1, #2, #3, #4, #5)
    - [ ] Subtask 4.1: Create `tests/commands/test_import.py`.
    - [ ] Subtask 4.2: Write unit tests, mocking the `Importer` service to verify it's called correctly based on flags (`--yes`, `--dry-run`).
    - [ ] Subtask 4.3: Write an E2E test that runs `capsule import` on a fixture capsule against a temporary vault.
    - [ ] Subtask 4.4: In the E2E test, verify that the backup is created, files are correctly added/merged, and the final vault state is as expected.
    - [ ] Subtask 4.5: Add an E2E test for the `--dry-run` flag to ensure no changes are made.
- [ ] **Task 5: Finalize Documentation and Error Handling**
    - [ ] Subtask 5.1: Add a detailed docstring with examples to the `import_capsule` command.
    - [ ] Subtask 5.2: Implement robust error handling for `CapsuleError` exceptions raised by the core services.
    </tasks>
  </story>
  <acceptanceCriteria>
1.  **AC-10.6**: The `capsule import <path>` command displays an accurate preview of changes (new files, updates, conflicts) and waits for user confirmation.
2.  **AC-10.7**: The import proceeds successfully after the user confirms the preview, creating a backup, and applying changes to the vault.
3.  **AC-10.8**: The `capsule import <path> --yes` command proceeds with the import without an interactive prompt.
4.  **AC-10.9**: The `capsule import <path> --dry-run` command displays the preview and exits without making any changes.
5.  **AC-10.10**: A backup of the vault is automatically created before the import process begins (unless `--no-backup` is specified).
  </acceptanceCriteria>
  <artifacts>
        <docs>
      <doc path="docs/sprint-artifacts/tech-spec-epic-10.md" title="Epic 10 Tech Spec" section="APIs and Interfaces" snippet="Defines the Typer signature for the `capsule import` command, including arguments like --yes and --dry-run."/>
      <doc path="docs/sprint-artifacts/tech-spec-epic-10.md" title="Epic 10 Tech Spec" section="Import Workflow" snippet="Details the sequence of operations for an import: instantiate Importer, get preview, prompt user, execute import (which triggers backup and merge)."/>
      <doc path="docs/architecture.md" title="Architecture Document" section="Epic Group 4: Import/Export Operations (FR26-FR31)" snippet="Describes the high-level architecture for import/export, including the roles of the Importer, Exporter, and Backup components."/>
      <doc path="docs/architecture.md" title="Architecture Document" section="CLI Command Structure Pattern" snippet="Provides the standard pattern for implementing Typer CLI commands, including error handling, progress indicators, and orchestrating core services."/>
    </docs>
        <code>
      <artifact path="capsule/core/importer.py" kind="Core Service" symbol="Importer" lines="" reason="Primary orchestrator for the import process. This existing service will be invoked by the new command to handle preview generation and execution logic."/>
      <artifact path="capsule/core/merger.py" kind="Core Service" symbol="Merger" lines="" reason="Handles the frontmatter merge logic. It's a key dependency of the Importer service."/>
      <artifact path="capsule/utils/backup.py" kind="Utility" symbol="BackupManager" lines="" reason="Provides the critical pre-import backup functionality. The Importer service calls this utility before making any changes."/>
      <artifact path="capsule/cli.py" kind="CLI Entrypoint" symbol="app" lines="" reason="The main Typer application file where the new `import_capsule` command must be registered."/>
      <artifact path="capsule/commands/import_cmd.py" kind="New Command" symbol="import_capsule" lines="" reason="This is the new file to be created for the command's implementation."/>
      <artifact path="tests/commands/test_import.py" kind="New Test" symbol="" lines="" reason="This is the new test file to be created, with a focus on E2E testing."/>
    </code>
        <dependencies>
      <dependency path="pyproject.toml" type="Poetry" name="typer" reason="The core CLI framework for defining the command, arguments, and options."/>
      <dependency path="pyproject.toml" type="Poetry" name="rich" reason="Used for displaying the formatted preview of the import to the user."/>
      <dependency path="pyproject.toml" type="Poetry" name="questionary" reason="Used to create the interactive prompt for the user to confirm or cancel the import."/>
    </dependencies>
  </artifacts>
    <constraints>
    <constraint type="Architectural Pattern" source="Dev Notes / architecture.md">The command must be a thin wrapper that orchestrates calls to core services (Importer, Merger, BackupManager). Business logic must remain in the core layer.</constraint>
    <constraint type="Dependency" source="Dev Notes">The implementation must use the existing `Importer`, `Merger`, and `Backup` services and not replicate their logic.</constraint>
    <constraint type="Reliability" source="tech-spec-epic-10.md">Imports must be atomic. If any step fails, the operation should be rolled back. This is handled by the Importer service's transactional logic.</constraint>
    <constraint type="User Experience" source="Dev Notes">All user feedback (previews, summaries, errors) must be routed through the established `logger` with `RichHandler`, not `print()`.</constraint>
  </constraints>
    <interfaces>
    <interface name="import_capsule" kind="CLI Command Signature" path="docs/sprint-artifacts/tech-spec-epic-10.md">
      <signature>
def import_capsule(
    path: Path = typer.Argument(..., help="Path to the capsule file (.zip) or directory to import."),
    auto_approve: bool = typer.Option(False, "--yes", "-y", help="Automatically approve the import without a preview."),
    dry_run: bool = typer.Option(False, "--dry-run", help="Show the import preview without performing the import.")
):
      </signature>
    </interface>
  </interfaces>
  <tests>
    <standards>A strong emphasis is required on E2E tests for this command, as it involves file system changes and user interaction. Use a temporary directory (`tmp_path` fixture in pytest) as a simulated vault for E2E tests to ensure they are isolated and repeatable.</standards>
    <locations>
      <location path="tests/commands/test_import.py" description="Primary test file for the import command, to be created."/>
    </locations>
    <ideas>
      <idea ac="AC-10.6">E2E test: run `capsule import` on a fixture and capture stdout to verify the preview text is accurate.</idea>
      <idea ac="AC-10.7">E2E test: run `capsule import` against a temporary vault, provide interactive input, and verify files are correctly created/merged.</idea>
      <idea ac="AC-10.8">E2E test: run `capsule import --yes` and verify it completes without hanging on a prompt.</idea>
      <idea ac="AC-10.9">E2E test: run `capsule import --dry-run` and verify that no files in the temporary vault are modified.</idea>
      <idea ac="AC-10.10">Integration test: Mock the `BackupManager.create_backup` method and verify it is called exactly once before the `Importer.execute_import` method.</idea>
    </ideas>
  </tests>
</story-context>
