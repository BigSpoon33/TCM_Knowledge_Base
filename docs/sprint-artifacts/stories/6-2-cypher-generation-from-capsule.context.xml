<story-context id="{bmad_folder}/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>2</storyId>
    <title>cypher-generation-from-capsule</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-19</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/home/shuma/Documents/AI_Suite/Obsidian_Capsule_Delivery/docs/sprint-artifacts/6-2-cypher-generation-from-capsule.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer</asA>
    <iWant>to generate a `capsule-cypher.yaml` file from the contents of a capsule</iWant>
    <soThat>I can create a manifest of the capsule's contents and metadata.</soThat>
    <tasks>
      <task id="1" ac="1">Implement Cypher Generation Method
        <subtask id="1.1">Create a method in `CapsulePackager` to generate the cypher.</subtask>
        <subtask id="1.2">Add unit tests for the cypher generation method.</subtask>
      </task>
      <task id="2" ac="2">Populate Cypher Metadata
        <subtask id="2.1">Extract metadata from the capsule and add it to the cypher.</subtask>
        <subtask id="2.2">Add unit tests to verify the metadata in the cypher.</subtask>
      </task>
      <task id="3" ac="3">Populate Folder Structure
        <subtask id="3.1">Scan the capsule directory and add the folder structure to the cypher.</subtask>
        <subtask id="3.2">Add unit tests to verify the folder structure in the cypher.</subtask>
      </task>
      <task id="4" ac="4">Populate File Inventory
        <subtask id="4.1">Scan the capsule directory and add the file inventory to the cypher.</subtask>
        <subtask id="4.2">Add unit tests to verify the file inventory in the cypher.</subtask>
      </task>
      <task id="5" ac="5">Populate Data Schemas
        <subtask id="5.1">Extract data schemas from the capsule and add them to the cypher.</subtask>
        <subtask id="5.2">Add unit tests to verify the data schemas in the cypher.</subtask>
      </task>
      <task id="6" ac="6">Add Unit Tests for All ACs
        <subtask id="6.1">Create `tests/test_core/test_cypher_generation.py`.</subtask>
        <subtask id="6.2">Add tests for all aspects of cypher generation.</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">A method exists in `CapsulePackager` to generate a `capsule-cypher.yaml` file from a given capsule directory.</criterion>
    <criterion id="2">The generated cypher file contains the correct `capsule_id`, `name`, `version`, and `domain_type`.</criterion>
    <criterion id="3">The generated cypher file accurately lists the folder structure of the capsule.</criterion>
    <criterion id="4">The generated cypher file accurately inventories all files in the capsule, including their paths and IDs.</criterion>
    <criterion id="5">The generated cypher file includes the data schemas defined in the capsule.</criterion>
    <criterion id="6">Unit tests are added to `tests/test_core/test_cypher_generation.py` to verify the cypher generation logic.</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Capsule Cypher Structure (Implementation Detail)</section>
        <snippet>
          The capsule-cypher.yaml file is generated by packager.py and includes capsule_id, name, version, domain_type, folder_structure, contents, data_schemas, sequence_mode, and required_plugins.
        </snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Epic Group 3: Capsule Packaging (FR17-FR25)</section>
        <snippet>
          This epic covers Capsule Cypher Generation, File Inventory Management, Schema Validation, and Export to Distributable Format. Key components are capsule/models/cypher.py and capsule/core/packager.py.
        </snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Project Epics</title>
        <section>Epic 6: Capsule Packaging</section>
        <snippet>
          This epic includes the story '6-2-cypher-generation-from-capsule' which is about generating the capsule-cypher.yaml from the capsule contents.
        </snippet>
      </doc>
      <doc>
        <path>docs/index.md</path>
        <title>Project Documentation Index</title>
        <section>Contents</section>
        <snippet>
          Provides links to the main project documentation files, including usage and modules.
        </snippet>
      </doc>
    </docs>
    <code>
      <code>
        <path>capsule/core/packager.py</path>
        <kind>service</kind>
        <symbol>CapsulePackager</symbol>
        <lines>11-95</lines>
        <reason>This class contains the core logic for packaging capsules, including the `generate_cypher` method that needs to be implemented.</reason>
      </code>
      <code>
        <path>capsule/models/cypher.py</path>
        <kind>model</kind>
        <symbol>CapsuleCypher</symbol>
        <lines>10-170</lines>
        <reason>This dataclass defines the data structure for the `capsule-cypher.yaml` file that this story will generate.</reason>
      </code>
      <code>
        <path>tests/test_core/test_cypher_generation.py</path>
        <kind>test</kind>
        <symbol>N/A</symbol>
        <lines>N/A</lines>
        <reason>This new file will contain the unit tests for the cypher generation logic.</reason>
      </code>
    </code>
    <dependencies>
      <dependency ecosystem="python">
        <package>typer</package>
        <version>latest</version>
      </dependency>
      <dependency ecosystem="python">
        <package>python-frontmatter</package>
        <version>latest</version>
      </dependency>
      <dependency ecosystem="python">
        <package>ruamel.yaml</package>
        <version>latest</version>
      </dependency>
      <dependency ecosystem="python">
        <package>jinja2</package>
        <version>latest</version>
      </dependency>
      <dependency ecosystem="python">
        <package>pytest</package>
        <version>latest</version>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
      <constraint>The generated `capsule-cypher.yaml` must match the structure defined in the architecture document, including `capsule_id`, `name`, `version`, `domain_type`, `folder_structure`, `contents`, `data_schemas`, `sequence_mode`, and `required_plugins`.</constraint>
      <constraint>Unit tests should verify that the generated cypher file is well-formed and accurately reflects the contents of the capsule.</constraint>
    </constraints>
  <interfaces>
      <interface>
        <name>CapsulePackager.generate_cypher</name>
        <kind>function signature</kind>
        <signature>def generate_cypher(self) -> CapsuleCypher:</signature>
        <path>capsule/core/packager.py</path>
      </interface>
    </interfaces>
  <tests>
    <standards>
      The project uses pytest for testing. Tests are located in the `tests/` directory and mirror the source code structure. Unit tests for this story should verify that the generated cypher file is well-formed and accurately reflects the contents of the capsule.
    </standards>
    <locations>
      <location>tests/test_core/test_cypher_generation.py</location>
    </locations>
    <ideas>
      <idea ac="2">Verify the generated cypher contains the correct `capsule_id`, `name`, `version`, and `domain_type`.</idea>
      <idea ac="3">Verify the generated cypher accurately lists the folder structure.</idea>
      <idea ac="4">Verify the generated cypher accurately inventories all files.</idea>
      <idea ac="5">Verify the generated cypher includes the data schemas.</idea>
    </ideas>
  </tests>
</story-context>
