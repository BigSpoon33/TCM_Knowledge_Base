<story-context id="{bmad_folder}/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.4</storyId>
    <title>Research Result Data Model</title>
    <status>drafted</status>
    <generatedAt>2025-11-18</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-4-research-result-data-model.md</sourceStoryPath>
  </metadata>
  <story>
    <asA>a developer</asA>
    <iWant>a data model to structure the results of a research task</iWant>
    <soThat>the content, citations, and metadata can be handled in a standardized way</soThat>
    <tasks>
### Task 3.1: Implement `ResearchResult` Data Model

-   [ ] **Subtask 3.1.1:** Create the file `capsule/models/research.py`.
-   [ ] **Subtask 3.1.2:** Implement the `ResearchResult` data model with fields for `content`, `citations`, and `metadata`.
-   [ ] **Subtask 3.1.3:** Create the test file `tests/test_models/test_research.py`.
-   [ ] **Subtask 3.1.4:** Write unit tests to validate the `ResearchResult` model.

### Task 3.2: Update Research Provider

-   [ ] **Subtask 3.2.1:** Update the `ResearchProvider` ABC in `capsule/core/researcher.py` to return a `ResearchResult` object.
-   [ ] **Subtask 3.2.2:** Update the `GeminiResearchProvider` to return a `ResearchResult` object.
-   [ ] **Subtask 3.2.3:** Update the tests for `GeminiResearchProvider` in `tests/test_core/test_researcher.py` to assert that the returned object is a valid `ResearchResult` instance.
    </tasks>
  </story>
  <acceptanceCriteria>
1.  **ResearchResult Data Model:** A new data model, `ResearchResult`, is created in `capsule/models/research.py` to store the results of a research task.
2.  **Data Model Fields:** The `ResearchResult` model includes fields for `content` (str), `citations` (List[Citation]), and `metadata` (Dict).
3.  **Interface Update:** The `ResearchProvider` abstract base class in `capsule/core/researcher.py` is updated to reflect that its `research` method will return a `ResearchResult` object.
4.  **Implementation Update:** The `GeminiResearchProvider` is modified to return an instance of the `ResearchResult` model.
5.  **Model Unit Tests:** Unit tests are created in `tests/test_models/test_research.py` to validate the `ResearchResult` model.
6.  **Provider Unit Tests:** The unit tests for `GeminiResearchProvider` in `tests/test_core/test_researcher.py` are updated to verify that the provider correctly returns a `ResearchResult` object.
  </acceptanceCriteria>
  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Deep Research Provider Architecture</section>
        <snippet>Defines the plugin-based provider abstraction with Gemini as the v1.0 default. The provider interface is specified, which the new citation model will need to conform to.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>capsule/core/researcher.py</path>
        <kind>service</kind>
        <symbol>ResearchProvider</symbol>
        <lines>9-29</lines>
        <reason>The abstract base class that needs to be modified to return the new ResearchResult model.</reason>
      </file>
      <file>
        <path>capsule/core/researcher.py</path>
        <kind>service</kind>
        <symbol>GeminiResearchProvider</symbol>
        <lines>31-76</lines>
        <reason>The concrete implementation that must be updated to return a ResearchResult object.</reason>
      </file>
      <file>
        <path>capsule/models/research.py</path>
        <kind>model</kind>
        <symbol>ResearchResult</symbol>
        <lines>N/A</lines>
        <reason>This file needs to be created to define the structure of a research result.</reason>
      </file>
      <file>
        <path>tests/test_core/test_researcher.py</path>
        <kind>test</kind>
        <symbol>TestGeminiResearchProvider</symbol>
        <lines>N/A</lines>
        <reason>This test suite must be updated to validate the new ResearchResult return type.</reason>
      </file>
      <file>
        <path>tests/test_models/test_research.py</path>
        <kind>test</kind>
        <symbol>TestResearchResultModel</symbol>
        <lines>N/A</lines>
        <reason>This test file needs to be created to validate the new ResearchResult model.</reason>
      </file>
    </code>
    <dependencies>
      <dependency>
        <ecosystem>python</ecosystem>
        <package>google-generativeai</package>
        <version>>=0.3.0</version>
        <reason>The library used to interact with the Google Gemini API for deep research.</reason>
      </dependency>
    </dependencies>
  </artifacts>
  <constraints>
    <constraint>The `ResearchResult` model should be a simple data class, consistent with other models in `capsule/models/`.</constraint>
    <constraint>The `Citation` model from the previous story should be used for the `citations` field.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>ResearchProvider</name>
      <kind>class interface</kind>
      <signature>research(self, topic: str, max_sources: int = 10) -> Dict[str, str | List[Citation]]</signature>
      <path>capsule/core/researcher.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>The project uses pytest and follows a test pyramid approach, emphasizing unit tests. Mocks should be used to simulate external API calls, ensuring that tests are fast and reliable. All new logic should be accompanied by corresponding unit tests.</standards>
    <locations>
      <location>tests/test_models/</location>
      <location>tests/test_core/</location>
    </locations>
    <ideas>
      <idea for_ac="1, 2, 5">Test ResearchResult model instantiation: Verify that a `ResearchResult` object can be created with the correct data (content, citations, metadata) and that its attributes are stored properly.</idea>
      <idea for_ac="3, 4, 6">Test `GeminiResearchProvider` return type: Mock the Gemini API to return a response. Verify that the `research` method correctly returns a `ResearchResult` object.</idea>
    </ideas>
  </tests>
</story-context>
