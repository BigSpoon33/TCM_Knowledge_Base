<story-context id="docs/sprint-artifacts/stories/14-2-unit-tests-for-core-logic.context.xml" v="1.0">
  <metadata>
    <epicId>epic-14</epicId>
    <storyId>14-2</storyId>
    <title>Unit Tests for Core Logic</title>
    <status>drafted</status>
    <generatedAt>Sun Nov 23 2025</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/14-2-unit-tests-for-core-logic.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Developer</asA>
    <iWant>write comprehensive unit tests for the core business logic modules</iWant>
    <soThat>ensure the stability and correctness of the system's fundamental operations and prevent regressions</soThat>
    <tasks>
- [ ] Create `tests/test_core/test_generator.py` (AC: 1)
  - [ ] Test `ContentGenerator` initialization
  - [ ] Test `generate` method with mocks
- [ ] Create `tests/test_core/test_researcher.py` (AC: 2)
  - [ ] Test `GeminiResearchProvider` with mocked API
- [ ] Create `tests/test_core/test_packager.py` (AC: 3)
  - [ ] Test `Packager` logic
- [ ] Create `tests/test_core/test_importer.py` (AC: 4)
  - [ ] Test `Importer` logic
- [ ] Create `tests/test_core/test_exporter.py` (AC: 5)
  - [ ] Test `Exporter` logic
- [ ] Create `tests/test_core/test_validator.py` (AC: 6)
  - [ ] Test `Validator` logic
- [ ] Create `tests/test_core/test_merger.py` (AC: 7)
  - [ ] Test `section_level_merge`
  - [ ] Test `additive_merge`
  - [ ] Test `detect_conflicts`
- [ ] Run full test suite and verify all tests pass (AC: 8)
    </tasks>
  </story>

  <acceptanceCriteria>
1. Unit tests implemented for `generator.py` covering content generation logic.
2. Unit tests implemented for `researcher.py` with mocked external API calls.
3. Unit tests implemented for `packager.py` covering capsule packaging logic.
4. Unit tests implemented for `importer.py` covering import orchestration and conflict detection.
5. Unit tests implemented for `exporter.py` covering export logic.
6. Unit tests implemented for `validator.py` covering schema and inventory validation.
7. Unit tests implemented for `merger.py` covering section-level and additive merge strategies.
8. All tests pass successfully using `pytest`.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec.md</path>
        <title>Technical Specification</title>
        <section>Testing Strategy</section>
        <snippet>Test Pyramid: Unit Tests (80%) - Pure functions, Model validation, Utility functions. Test Organization: Tests live in tests/ mirroring source structure. Principle: Test contracts, not implementations.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Testing Framework</section>
        <snippet>Testing Framework: pytest (7.0+). De facto standard, fixtures, parametrization. Code Quality: black, flake8, mypy.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Project Epics</title>
        <section>Epic 14: Testing Infrastructure</section>
        <snippet>Summary: Test framework, unit tests, integration tests, E2E tests, CI integration. Story 14-2: Write unit tests for the core business logic.</snippet>
      </doc>
    </docs>
    <code>
      <item>
        <path>capsule/core/generator.py</path>
        <kind>module</kind>
        <symbol>ContentGenerator</symbol>
        <reason>Target for unit testing (AC 1)</reason>
      </item>
      <item>
        <path>capsule/core/researcher.py</path>
        <kind>module</kind>
        <symbol>GeminiResearchProvider</symbol>
        <reason>Target for unit testing with mocks (AC 2)</reason>
      </item>
      <item>
        <path>capsule/core/packager.py</path>
        <kind>module</kind>
        <symbol>Packager</symbol>
        <reason>Target for unit testing (AC 3)</reason>
      </item>
      <item>
        <path>capsule/core/importer.py</path>
        <kind>module</kind>
        <symbol>Importer</symbol>
        <reason>Target for unit testing (AC 4)</reason>
      </item>
      <item>
        <path>capsule/core/exporter.py</path>
        <kind>module</kind>
        <symbol>Exporter</symbol>
        <reason>Target for unit testing (AC 5)</reason>
      </item>
      <item>
        <path>capsule/core/validator.py</path>
        <kind>module</kind>
        <symbol>Validator</symbol>
        <reason>Target for unit testing (AC 6)</reason>
      </item>
      <item>
        <path>capsule/core/merger.py</path>
        <kind>module</kind>
        <symbol>Merger</symbol>
        <reason>Target for unit testing (AC 7)</reason>
      </item>
      <item>
        <path>tests/test_core/test_generator.py</path>
        <kind>test</kind>
        <symbol>TestContentGenerator</symbol>
        <reason>Existing test file to be updated/refactored to pytest</reason>
      </item>
    </code>
    <dependencies>
      <package>pytest</package>
      <package>pytest-mock</package>
      <package>coverage</package>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use pytest as the testing framework.</constraint>
    <constraint>Use pytest-mock for mocking external dependencies (APIs, file system).</constraint>
    <constraint>Tests must be placed in tests/test_core/ mirroring the source structure.</constraint>
    <constraint>Ensure high code coverage for core logic.</constraint>
    <constraint>Do not make actual API calls during unit tests.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>ResearchProvider</name>
      <kind>Abstract Base Class</kind>
      <signature>research(topic: str, max_sources: int) -> ResearchResult</signature>
      <path>capsule/core/researcher.py</path>
    </interface>
    <interface>
      <name>ContentGenerator.generate</name>
      <kind>Method</kind>
      <signature>generate(topic: str, template: str, materials: List[str]) -> Capsule</signature>
      <path>capsule/core/generator.py</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use pytest with pytest-mock. Follow the Test Pyramid: 80% Unit Tests. Mock all external interactions. Use fixtures for setup/teardown. Naming convention: test_&lt;module&gt;.py.</standards>
    <locations>tests/test_core/</locations>
    <ideas>
      <idea>Mock GeminiResearchProvider to return predefined ResearchResult without network calls.</idea>
      <idea>Mock file system operations in Packager/Importer using pyfakefs or tmp_path fixture.</idea>
      <idea>Test section_level_merge with conflicting and non-conflicting data.</idea>
      <idea>Test additive_merge with new sections from different capsules.</idea>
      <idea>Test Validator against valid and invalid schema examples.</idea>
    </ideas>
  </tests>
</story-context>
