<story-context id="{bmad_folder}/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>{{epic_id}}</epicId>
    <storyId>{{story_id}}</storyId>
    <title>{{story_title}}</title>
    <status>{{story_status}}</status>
    <generatedAt>{{date}}</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>{{story_path}}</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user</asA>
    <iWant>to confirm or deny an import operation after reviewing the preview</iWant>
    <soThat>I can prevent accidental changes to their vault</soThat>
    <tasks>
      - [ ] **Task 1: Implement Interactive Prompt** (AC: #1, #2, #3, #4)
        - [ ] Subtask 1.1: In `capsule/commands/import_cmd.py`, use `typer.confirm()` to create the interactive prompt after the preview is shown.
        - [ ] Subtask 1.2: If the user aborts, print a confirmation message and raise a `typer.Exit()`.
      - [ ] **Task 2: Add Bypass Flag** (AC: #5, #6)
        - [ ] Subtask 2.1: Add a `--force: bool` option to the `import_capsule` function in `capsule/commands/import_cmd.py`.
        - [ ] Subtask 2.2: Wrap the `typer.confirm()` call in a conditional check for the `--force` flag.
      - [ ] **Task 3: Update Unit Tests** (AC: #1-#6)
        - [ ] Subtask 3.1: In `tests/test_commands/test_import.py`, add tests to simulate user input ('y' and 'n') using patching.
        - [ ] Subtask 3.2: Add a test to verify that the `--force` flag correctly bypasses the prompt.
        - [ ] Subtask 3.3: Ensure existing tests are updated to handle the new interactive prompt or use the bypass flag.
    </tasks>
  </story>

  <acceptanceCriteria>
    1. The `capsule import` command MUST prompt the user for confirmation after the preview is displayed.
    2. The prompt MUST accept 'y' (yes) or 'n' (no) as input (case-insensitive).
    3. If the user enters 'y', the import process MUST continue.
    4. If the user enters 'n', the import process MUST be aborted with a "User cancelled" message, and the application MUST exit gracefully.
    5. A `--force` or `--auto-approve` flag MUST be added to the `import` command to bypass the interactive prompt for automation purposes.
    6. When the bypass flag is used, the import MUST proceed without waiting for user input.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Project Epics</title>
        <section>Epic 7: Import/Export Operations</section>
        <snippet>Summary: Backup management, import/export commands, version conflict detection, preview. Story 7-6: Implement an interactive approval step for imports.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>CLI Command Structure Pattern</section>
        <snippet>Defines the standard structure for implementing CLI commands using Typer, including argument parsing, progress indicators, and error handling. Relevant for adding the --force flag and the interactive prompt.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Error Handling Strategy</section>
        <snippet>Outlines the use of custom exceptions like UserCancelledError and a consistent pattern for reporting errors to the user, which is critical for handling the 'n' input from the user gracefully.</snippet>
      </doc>
      <doc>
        <path>OCDS_Documentation/06_Automation_Scripts/Script_Overview.md</path>
        <title>Automation Scripts Overview</title>
        <section>Script Flags Reference</section>
        <snippet>This document lists common flags for all scripts, including `--force` to "Force overwrite". This establishes a project pattern for the bypass flag required in this story.</snippet>
      </doc>
      <doc>
        <path>OCDS_Documentation/11_Distribution/Import_Instructions.md</path>
        <title>Import Instructions</title>
        <section>For Students</section>
        <snippet>Provides the user-facing instructions for the import process. The interactive approval workflow is a direct modification of this user experience.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>capsule/commands/import_cmd.py</path>
        <kind>command</kind>
        <symbol>import_cmd</symbol>
        <lines>11-73</lines>
        <reason>Primary file to be modified. The interactive prompt and --force flag will be added here.</reason>
      </artifact>
      <artifact>
        <path>tests/test_commands/test_import_cmd.py</path>
        <kind>test</kind>
        <symbol>TestImportCommand</symbol>
        <lines>115-178</lines>
        <reason>Unit tests for the import command. New tests are required to simulate user input and verify the --force flag.</reason>
      </artifact>
      <artifact>
        <path>capsule/exceptions.py</path>
        <kind>exception</kind>
        <symbol>UserCancelledError</symbol>
        <lines>19-21</lines>
        <reason>This custom exception should be raised when the user chooses to cancel the import.</reason>
      </artifact>
    </code>
    <dependencies>
      <dependency>
        <name>typer</name>
        <version>latest</version>
        <reason>Core CLI framework. `typer.confirm()` is the required tool for the interactive prompt.</reason>
      </dependency>
      <dependency>
        <name>pytest</name>
        <version>latest</version>
        <reason>Testing framework used for unit tests. Will be needed to write new tests for this story.</reason>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Must use `typer.confirm()` for the interactive prompt as specified in the Dev Notes.</constraint>
    <constraint>The `--force` flag should be used to bypass the prompt, not `--auto-approve`.</constraint>
    <constraint>On user cancellation, the application must exit gracefully with a clear message and raise a `typer.Exit()`.</constraint>
    <constraint>Follows the established CLI Command Structure and Error Handling patterns from the architecture document.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>import_cmd</name>
      <kind>function signature</kind>
      <signature>def import_cmd(capsule_path: Path, target_vault: Path = None, no_backup: bool = False, force: bool = False)</signature>
      <path>capsule/commands/import_cmd.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Tests are written using pytest and follow the structure in the architecture document. Core logic is unit tested, and CLI commands are tested using `typer.testing.CliRunner`. Tests should mock external dependencies and file system operations where appropriate.
    </standards>
    <locations>
      <location>tests/test_commands/test_import_cmd.py</location>
    </locations>
    <ideas>
      <idea for="AC #1, #3">Test that when the user inputs 'y', the import process continues (mocked).</idea>
      <idea for="AC #2, #4">Test that when the user inputs 'n', the process aborts with the correct message and a UserCancelledError is raised.</idea>
      <idea for="AC #5, #6">Test that when the `--force` flag is used, the confirmation prompt is skipped entirely.</idea>
      <idea for="AC #2">Test that the prompt is case-insensitive ('Y' and 'N' are also accepted).</idea>
    </ideas>
  </tests>
</story-context>
